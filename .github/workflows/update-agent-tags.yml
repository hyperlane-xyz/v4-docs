name: Update Hyperlane Agent Tags

on:
  schedule:
    # Run weekly on Mondays at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual triggering
  push:
    branches:
      - pb/agent-tag-updates

jobs:
  update-agent-tags:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Configure Git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Get latest agent release tag
        id: get-tag
        run: |
          # Fetch releases from GitHub API and filter using same pattern as monorepo
          # Only stable releases matching agents-vX.Y.Z (no prerelease suffixes)
          LATEST_TAG=$(curl -s https://api.github.com/repos/hyperlane-xyz/hyperlane-monorepo/releases \
            | jq -r '.[] | select(.prerelease == false and .draft == false) | .tag_name' \
            | grep -E "^agents-v[0-9]+\.[0-9]+\.[0-9]+$" \
            | head -1)

          if [ -z "$LATEST_TAG" ]; then
            echo "Error: Could not find a production release starting with 'agents-v'"
            exit 1
          fi

          echo "tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "Latest production agent tag: $LATEST_TAG"

      - name: Update agent tags in documentation
        run: |
          # Find the current agent tag version in the docs
          CURRENT_TAG=$(grep -ohP 'gcr\.io/abacus-labs-dev/hyperlane-agent:\K(agents-v[0-9]+\.[0-9]+\.[0-9]+)' docs/ -r | head -1)
          NEW_TAG="${{ steps.get-tag.outputs.tag }}"

          echo "Current tag: $CURRENT_TAG"
          echo "New tag: $NEW_TAG"

          # Validate current tag format
          if [ -z "$CURRENT_TAG" ]; then
            echo "Error: Could not find current agent tag in docs"
            exit 1
          fi

          if [[ ! "$CURRENT_TAG" =~ ^agents-v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Current tag format is invalid: $CURRENT_TAG"
            exit 1
          fi

          # If tags are the same, exit gracefully
          if [ "$CURRENT_TAG" = "$NEW_TAG" ]; then
            echo "Agent tags are already up to date"
            exit 0
          fi

          # Update all occurrences in markdown files
          find docs -name "*.mdx" -type f -print0 | xargs -0 sed -i "s|gcr\.io/abacus-labs-dev/hyperlane-agent:$CURRENT_TAG|gcr.io/abacus-labs-dev/hyperlane-agent:$NEW_TAG|g"

          echo "Updated agent tags from $CURRENT_TAG to $NEW_TAG"

      - name: Check for changes and create PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if ! git diff --quiet; then
            # Get list of changed files for PR description
            CHANGED_FILES=$(git diff --name-only | sed 's/^/- /')

            git checkout -b ci/update-agent-tags
            git add -A
            git commit -m "chore: update agent tag to ${{ steps.get-tag.outputs.tag }}

          - Update agent Docker image tag to ${{ steps.get-tag.outputs.tag }}
          - Updated in all documentation files"

            git push -fu origin ci/update-agent-tags

            PR_TITLE="chore: update agent tag to ${{ steps.get-tag.outputs.tag }}"
            PR_BODY="## Automated Agent Tag Update

          This PR updates the Hyperlane agent Docker image tags to the latest version.

          **Updated version:**
          - Agent tag: \`${{ steps.get-tag.outputs.tag }}\`

          **Files updated:**
          $CHANGED_FILES

          ---
          ðŸ¤– This PR was automatically generated by the [update-agent-tags workflow](.github/workflows/update-agent-tags.yml)"

            PR_EXISTS=$(gh pr list --base main --head ci/update-agent-tags --json number --jq length)
            if [ "$PR_EXISTS" -eq "0" ]; then
              gh pr create \
                --base main \
                --head ci/update-agent-tags \
                --title "$PR_TITLE" \
                --body "$PR_BODY"
            else
              echo "Pull request already exists. Updating title and description..."
              gh pr edit ci/update-agent-tags \
                --title "$PR_TITLE" \
                --body "$PR_BODY"
            fi
          else
            echo "No changes detected. Skipping PR creation."
          fi
