name: Update Hyperlane Dependencies

on:
  schedule:
    # Run weekly on Mondays at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual triggering

jobs:
  update-dependencies:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Configure Git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'yarn'
          cache-dependency-path: 'scripts/yarn.lock'

      - name: Get latest SDK and Registry versions
        id: get-versions
        run: |
          cd scripts
          LATEST_SDK=$(yarn info @hyperlane-xyz/sdk version --json | jq -r '.data')
          LATEST_REGISTRY=$(yarn info @hyperlane-xyz/registry version --json | jq -r '.data')
          echo "sdk=$LATEST_SDK" >> $GITHUB_OUTPUT
          echo "registry=$LATEST_REGISTRY" >> $GITHUB_OUTPUT
          echo "Latest SDK: $LATEST_SDK"
          echo "Latest Registry: $LATEST_REGISTRY"

      - name: Update package.json with latest versions
        run: |
          cd scripts
          npm pkg set dependencies.@hyperlane-xyz/sdk=${{ steps.get-versions.outputs.sdk }}
          npm pkg set dependencies.@hyperlane-xyz/registry=${{ steps.get-versions.outputs.registry }}

      - name: Install dependencies
        run: |
          cd scripts
          yarn install

      - name: Run generate-all script
        run: |
          cd scripts
          node generate-all.js

      - name: Check for changes and create PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if ! git diff --quiet; then
            git checkout -b ci/update-hl-deps
            git add -A
            git commit -m "chore: update Hyperlane deps to SDK ${{ steps.get-versions.outputs.sdk }} and Registry ${{ steps.get-versions.outputs.registry }}

          - Update @hyperlane-xyz/sdk to ${{ steps.get-versions.outputs.sdk }}
          - Update @hyperlane-xyz/registry to ${{ steps.get-versions.outputs.registry }}
          - Regenerate all artifacts"

            git push -fu origin ci/update-hl-deps

            PR_EXISTS=$(gh pr list --base main --head ci/update-hl-deps --json number --jq length)
            if [ "$PR_EXISTS" -eq "0" ]; then
              gh pr create \
                --base main \
                --head ci/update-hl-deps \
                --title "chore: update Hyperlane SDK and Registry to latest versions" \
                --body "## Automated Dependency Update

          This PR updates the Hyperlane dependencies to their latest versions and regenerates all artifacts.

          **Updated versions:**
          - \`@hyperlane-xyz/sdk\`: \`${{ steps.get-versions.outputs.sdk }}\`
          - \`@hyperlane-xyz/registry\`: \`${{ steps.get-versions.outputs.registry }}\`

          **Changes include:**
          - Updated \`scripts/package.json\` with latest SDK and Registry versions
          - Updated \`scripts/yarn.lock\` via \`yarn install\`
          - Regenerated all documentation artifacts via \`generate-all.js\`

          ---
          ðŸ¤– This PR was automatically generated by the [update-hyperlane-deps workflow](.github/workflows/update-hyperlane-deps.yml)"
            else
              echo "Pull request already exists. Branch updated with latest changes."
            fi
          else
            echo "No changes detected. Skipping PR creation."
          fi
